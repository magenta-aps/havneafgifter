{% extends "havneafgifter/base_default.html" %}

{% load i18n %}
{% load static %}
{% load django_bootstrap5 %}
{% load bootstrap_modal %}

{% block title %}
{% translate "Harbour Dues/Port Tax" %}
{% endblock %}

{% block extra_headers %}
<script nonce="{{ request.csp_nonce }}" src="{% url 'javascript-catalog' %}"></script>
<script nonce="{{ request.csp_nonce }}" src="{% static 'havneafgifter/form_actions.js' %}"></script>
<script nonce="{{ request.csp_nonce }}" src="{% static 'havneafgifter/form_step_1.js' %}"></script>
{% endblock %}

{% block content %}
<h1>{% translate "Harbour Dues/Port Tax" %}</h1>
<form action="." method="post" class="form" id="main" novalidate data-user-type="{{ user.user_type }}">
    {% csrf_token %}
    {{ base_form.media.css }}
    {{ base_form.media.js }}

    {% if base_form.user_visible_non_field_errors %}
    <ul class="list-unstyled text-danger">
        {% for error in base_form.user_visible_non_field_errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
    {% endif %}

    <div class="row bg-light rounded-3 m-0 mt-3 p-4">
        <div class="col-6">
            {% bootstrap_form base_form layout="horizontal" horizontal_label_class="col-6" horizontal_field_class="col-6" exclude="nationality,vessel_imo,vessel_master,gross_tonnage,datetime_of_departure,no_port_of_call,status,vessel_type" alert_error_type="none" %}
            {% bootstrap_field base_form.vessel_type wrapper_class="pt-3 " layout="horizontal" horizontal_label_class="col-6" horizontal_field_class="col-6" %}
        </div>
        <div class="col-6">
            {% bootstrap_form base_form layout="horizontal" horizontal_label_class="col-6" horizontal_field_class="col-6" exclude="port_of_call,vessel_name,vessel_owner,shipping_agent,datetime_of_arrival,vessel_type,no_port_of_call,status" alert_error_type="none" %}
        </div>
    </div>

    {# Formset asking for number of passenger of each nationality #}
    {% bootstrap_form passenger_formset.management_form %}
    <div class="formset bg-light rounded-3 mt-3 p-4">
        <h2 class="pb-3">{% translate 'Cruise Ships: Passenger Tax ("Pax Tax")' %}</h2>
        {% for form in passenger_formset.forms %}
        <div class="formset-item row mb-3">
            <div class="col-6 d-flex justify-content-between">
                {% bootstrap_field form.DELETE wrapper_class="d-none" %}
                {% bootstrap_field form.nationality show_label=False wrapper_class="col-7 me-5" %}
                {% bootstrap_field form.number_of_passengers show_label=False wrapper_class="col-4 me-3" %}
                <div class="col-2 button-location">
                    <button class="btn btn-primary minus-button">-</button>
                    {% if forloop.last %}
                    <button class="btn btn-primary plus-button">+</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {# Formset asking for number of passengers at each disembarkment site #}
    {% bootstrap_form disembarkment_formset.management_form %}
    <div class="formset bg-light rounded-3 mt-3 p-4">
        <h2 class="pb-3">{% translate 'Cruise Ships: Environmental and Maintenance Fee' %}</h2>
        {% for form in disembarkment_formset.forms %}
        <div class="formset-item row mb-3">
            <div class="col-6 d-flex justify-content-between">
                {% bootstrap_field form.DELETE wrapper_class="d-none" %}
                {% bootstrap_field form.disembarkment_site show_label=False wrapper_class="col-7 me-5" %}
                {% bootstrap_field form.number_of_passengers show_label=False wrapper_class="col-4 me-3" %}
                <div class="col-2 button-location">
                    <button type="button" class="btn btn-primary minus-button">-</button>
                    {% if forloop.last %}
                    <button type="button" class="btn btn-primary plus-button">+</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <hr>

    {% if user_is_ship and object.shipping_agent is not None %}
        {# Ship users can only create DRAFT cruise ship forms if a shipping agent has been specified #}
        {% bootstrap_button button_type="submit" name="status" value="DRAFT" content=_("Forward to agent") %}
    {% else %}
        {# Pass `status=NEW` or `status=DRAFT` depending on which submit button is used #}
        {% bootstrap_button button_type="submit" name="status" value="NEW" content=_("Submit") %}
        {% bootstrap_button button_type="submit" name="status" value="DRAFT" content=_("Save as draft") %}
    {% endif %}
    <input type="hidden" name="status" />
</form>
{# Popups for ship users #}
{% inform_ship_user_on_save_shipping_agent_modal object %}
{% inform_ship_user_on_save_no_shipping_agent_modal object %}
{% inform_ship_user_on_submit_modal object %}

<script nonce="{{ request.csp_nonce }}">
    $(document).ready(function() {
        const foo = $("[for=id_base-vessel_type]")
        foo.append($('<span class="material-icons dark-icon ms-1 align-text-bottom" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Tooltip on top">info</span>'))

        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    });

    $("[name={{ base_form.vessel_imo.name }}]").on("invalid", function () {
        if (this.validity.tooShort || this.validity.tooLong) {
            this.setCustomValidity("{% translate 'IMO numbers should be 7 digits' %}");
        } else {
            this.setCustomValidity("");
            this.reportValidity();
        }
    });

    function removeItem(e) {
        e.preventDefault();

        const container = $(e.target).parents(".formset-item");

        const children = $(".formset-item", container.closest(".formset")).not(".d-none")

        // Wont delete the last element
        if (children.length > 1) {
            const deleteCheckbox = $(".form-check-input", container)
            deleteCheckbox.attr("checked", !deleteCheckbox.attr("checked"))
            container.addClass("d-none")

            const plusButton = $(".plus-button", container)

            if (plusButton.length) {
                const previous = $(".button-location", container.prevAll(".formset-item").not(".d-none").first())
                previous.append(plusButton)
            }
        } else {
            alert("{% translate 'You cannot delete the last item' %}")
        }
    }

    function addItem(e) {
        e.preventDefault();

        const container = $(e.target).parents(".formset-item")

        container.clone().insertAfter(container)

        const plusButton = $(".plus-button", container)
        plusButton.remove()

        $(".plus-button").off("click")
        $(".minus-button").off("click")
        $(".plus-button").on("click", addItem);
        $(".minus-button").on("click", removeItem);
    }

    $(".plus-button").on("click", addItem)
    $(".minus-button").on("click", removeItem)
</script>
{% endblock content %}
